<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Map - Coastline Prediction</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .controls label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .slider {
            width: 100%;
            margin-bottom: 10px;
        }
        .info {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .info-item {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            min-width: 150px;
        }
        .info-item .label {
            font-weight: bold;
            color: #495057;
        }
        .info-item .value {
            color: #007bff;
            font-size: 1.1em;
        }
        #map {
            height: 600px;
            width: 100%;
            border: 2px solid #333;
            background-color: #f0f0f0;
        }
        .debug {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.active {
            background: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŒŠ Debug Map - Coastline Prediction</h1>
        
        <div class="controls">
            <label for="year-slider">Year: <span id="current-year">2024</span></label>
            <input type="range" id="year-slider" min="1950" max="2100" value="2024" class="slider">
            
            <div>
                <button id="toggle-points" class="btn active">Show Points</button>
                <button id="toggle-contours" class="btn">Show Contours</button>
                <button id="reset-view" class="btn">Reset View</button>
                <button id="test-data" class="btn">Test Data</button>
            </div>
        </div>
        
        <div class="info">
            <div class="info-item">
                <div class="label">Data Type:</div>
                <div class="value" id="data-type">Historical</div>
            </div>
            <div class="info-item">
                <div class="label">Data Points:</div>
                <div class="value" id="data-count">0</div>
            </div>
            <div class="info-item">
                <div class="label">Map Center:</div>
                <div class="value" id="map-center">Loading...</div>
            </div>
            <div class="info-item">
                <div class="label">Zoom Level:</div>
                <div class="value" id="zoom-level">-</div>
            </div>
        </div>
        
        <div id="map"></div>
        
        <div class="debug" id="debug-log">
            <div>Debug Log:</div>
            <div id="log-content"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let currentYear = 2024;
        let currentBounds = null;
        let pointLayers = [];
        let contourLayers = [];
        let showPoints = true;
        let showContours = false;

        // Debug logging
        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        // Initialize map
        function initMap() {
            log('Initializing map...');
            
            try {
                // Create map centered on Florida
                map = L.map('map').setView([27.7663, -82.6404], 6);
                log('Map created successfully');
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
                log('Tile layer added');
                
                // Add event listeners
                map.on('moveend', function() {
                    updateMapInfo();
                });
                
                map.on('zoomend', function() {
                    updateMapInfo();
                });
                
                log('Map initialization complete');
                updateMapInfo();
                
                // Load initial data
                loadDataForYear(currentYear);
                
            } catch (error) {
                log('Error initializing map: ' + error.message);
            }
        }

        // Update map information display
        function updateMapInfo() {
            if (map) {
                const center = map.getCenter();
                const zoom = map.getZoom();
                const bounds = map.getBounds();
                
                document.getElementById('map-center').textContent = 
                    `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
                document.getElementById('zoom-level').textContent = zoom;
                
                currentBounds = [
                    bounds.getSouth(),
                    bounds.getWest(),
                    bounds.getNorth(),
                    bounds.getEast()
                ];
                
                log(`Map moved: Center(${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}), Zoom(${zoom})`);
            }
        }

        // Load data for specific year
        function loadDataForYear(year) {
            log(`Loading data for year: ${year}`);
            
            const boundsParam = currentBounds ? currentBounds.join(',') : '';
            const url = `http://localhost:5000/api/data/${year}?bounds=${boundsParam}`;
            log(`Fetching: ${url}`);
            
            fetch(url)
                .then(response => {
                    log(`Response status: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    log(`Data received: ${data.points ? data.points.length : 0} points, ${data.contours ? data.contours.length : 0} contours`);
                    displayData(data);
                    updateUI(data);
                })
                .catch(error => {
                    log('Error loading data: ' + error.message);
                });
        }

        // Display data on map
        function displayData(data) {
            // Clear existing layers
            clearLayers();
            
            if (data.points && showPoints) {
                displayPoints(data.points);
            }
            
            if (data.contours && showContours) {
                displayContours(data.contours);
            }
        }

        // Display individual points
        function displayPoints(points) {
            log(`Displaying ${points.length} points`);
            
            points.forEach((point, index) => {
                const marker = L.circleMarker([point[1], point[0]], {
                    radius: 4,
                    fillColor: 'blue',
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                marker.bindPopup(`Point ${index + 1}<br>Lat: ${point[1]}<br>Lon: ${point[0]}`);
                pointLayers.push(marker);
            });
            
            log(`Added ${pointLayers.length} point markers to map`);
        }

        // Display contour lines
        function displayContours(contours) {
            log(`Displaying ${contours.length} contours`);
            
            contours.forEach(contour => {
                if (contour.points.length > 1) {
                    const polyline = L.polyline(contour.points, {
                        color: contour.color,
                        weight: 3,
                        opacity: 0.8
                    }).addTo(map);
                    
                    polyline.bindPopup(`Elevation: ${contour.level}`);
                    contourLayers.push(polyline);
                }
            });
        }

        // All coastline points are blue since they represent the coastline
        function getPointColor() {
            return 'blue';
        }

        // Clear all layers
        function clearLayers() {
            pointLayers.forEach(layer => map.removeLayer(layer));
            contourLayers.forEach(layer => map.removeLayer(layer));
            pointLayers = [];
            contourLayers = [];
        }

        // Update UI elements
        function updateUI(data) {
            document.getElementById('current-year').textContent = currentYear;
            document.getElementById('data-count').textContent = data.points ? data.points.length : 0;
            document.getElementById('data-type').textContent = 
                data.data_type === 'historical' ? 'Historical' : 'Predicted';
        }

        // Event listeners
        document.getElementById('year-slider').addEventListener('input', function(e) {
            currentYear = parseInt(e.target.value);
            loadDataForYear(currentYear);
        });

        document.getElementById('toggle-points').addEventListener('click', function() {
            showPoints = !showPoints;
            this.classList.toggle('active');
            log(`Points display: ${showPoints ? 'ON' : 'OFF'}`);
            // Reload current data
            loadDataForYear(currentYear);
        });

        document.getElementById('toggle-contours').addEventListener('click', function() {
            showContours = !showContours;
            this.classList.toggle('active');
            log(`Contours display: ${showContours ? 'ON' : 'OFF'}`);
            // Reload current data
            loadDataForYear(currentYear);
        });

        document.getElementById('reset-view').addEventListener('click', function() {
            map.setView([27.7663, -82.6404], 6);
            log('View reset to default');
        });

        document.getElementById('test-data').addEventListener('click', function() {
            // Add some test markers
            const testPoints = [
                [40.7128, -74.0060],
                [39.9526, -75.1652],
                [38.9072, -77.0369],
                [36.1699, -115.1398],
                [25.7617, -80.1918]
            ];
            
            testPoints.forEach((point, index) => {
                const marker = L.marker([point[0], point[1]]).addTo(map);
                marker.bindPopup(`Test Point ${index + 1}<br>Lat: ${point[0]}<br>Lon: ${point[1]}`);
            });
            
            log(`Added ${testPoints.length} test markers`);
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded, initializing map...');
            initMap();
        });
    </script>
</body>
</html>
